/* MySQL root account: root@localhost/password */

create database rhover;
create user 'rhover'@'localhost' identified by 'rhover';
grant all privileges on rhover.* to 'rhover'@'localhost';

create table study (
	study_id BIGINT AUTO_INCREMENT PRIMARY KEY,
	study_name VARCHAR(50),
	last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

create table dataset (
	dataset_id BIGINT AUTO_INCREMENT PRIMARY KEY,
	dataset_name VARCHAR(50),
	study_id BIGINT,
	last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	foreign key(study_id) references study(study_id)
);

create table dataset_version (
	dataset_version_id BIGINT AUTO_INCREMENT PRIMARY KEY,
	dataset_version_name VARCHAR(50),
	dataset_id BIGINT,
	last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	foreign key(dataset_id) references dataset(dataset_id)
);

create table data_field (
	data_field_id BIGINT AUTO_INCREMENT PRIMARY KEY,
	data_field_name VARCHAR(200),
	dataset_id BIGINT,
	lower_threshold DOUBLE,
	upper_threshold DOUBLE,
	last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	foreign key(dataset_id) references dataset (dataset_id)
);

create table anomaly (
	anomaly_id BIGINT AUTO_INCREMENT PRIMARY KEY,
	anomaly_type CHAR,
	data_field_id BIGINT,
	field_value VARCHAR(100),
	version_first_seen_in BIGINT,
	version_last_seen_in BIGINT,
	recruit_id VARCHAR(100),
	event VARCHAR(100),
	has_been_viewed TINYINT DEFAULT 0,
	is_an_issue TINYINT DEFAULT 1,
	last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	foreign key(data_field_id) references data_field(data_field_id),
	foreign key(version_first_seen_in) references dataset_version(dataset_version_id),
	foreign key(version_last_seen_in) references dataset_version(dataset_version_id)
);

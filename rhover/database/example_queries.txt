select df.data_field_id, df.data_field_name, count(a.anomaly_id), count(a.has_been_viewed = 0)
from data_field df
join anomaly a on a.data_field_id = df.data_field_id
where df.dataset_id = 1
group by df.data_field_id, df.data_field_name

select ds.dataset_id, ds.dataset_name, count(a.anomaly_id), count(a.has_been_viewed = 0)
from dataset ds
join data_field df on df.dataset_id = ds.dataset_id
join anomaly a on a.data_field_id = df.data_field_id
where ds.study_id = 1
group by ds.dataset_id, ds.dataset_name

select s.study_id, s.study_name, count(a.anomaly_id), count(a.has_been_viewed = 0)
from study s
join dataset ds on ds.study_id = s.study_id
join data_field df on df.dataset_id = ds.dataset_id
join anomaly a on a.data_field_id = df.data_field_id
group by s.study_id, s.study_name

select a.recruit_id, a.event, a.field_value, dsv1.dataset_version_name, dsv2.dataset_version_name
from anomaly a
join dataset_version dsv1 on a.version_first_seen_in = dsv1.dataset_version_id
join dataset_version dsv2 on a.version_last_seen_in = dsv2.dataset_version_id
where a.data_field_id = 1
order by a.recruit_id, a.event

select max(version_last_seen_in) from anomaly where data_field_id = 1;

select s.study_name
from data_field df
join dataset ds on ds.dataset_id = df.dataset_id
join study s on s.study_id = ds.study_id
where df.data_field_id = 1

select ds.dataset_name
from dataset ds
join data_field df on df.dataset_id = ds.dataset_id
where df.data_field_id = 1

select s.study_name
from study s
join dataset ds on ds.study_id = s.study_id
join data_field df on df.dataset_id = ds.dataset_id
where df.data_field_id = 213

select a.site_id
from anomaly a
insert into bivariate_check(dataset_id_1, dataset_id_2, data_field_1, data_field_2, file_path)
values (77, 78, 'test1', 'test2', 'path')

update bivariate_check
set intercept = 2,
slope = 2,
residual_threshold = 1,
density_threshold = 1
where bivariate_check_id = 11

update bivariate_check
set is_het = 1,
lambda = 1
where bivariate_check_id = 21

select recruit_id, count(anomaly_id)
from anomaly
group by recruit_id
order by count(anomaly_id) desc
limit 50

select s.site_name,
(
	select count(*)
	from anomaly a
	where a.site_id = s.site_id
),
(
	select count(*)
	from anomaly a
	where a.site_id = s.site_id
	and a.has_been_viewed = 0
)
from site s
where s.study_id = 11

select s.subject_id, s.subject_name,
(
	select count(*)
	from anomaly a
	where a.subject_id = s.subject_id
) total,
(
	select count(*)
	from anomaly a
	where a.subject_id = s.subject_id
	and a.has_been_viewed = 0
),
si.site_name
from subject s
join site si on si.site_id = s.site_id
where si.study_id = 11
order by total desc
limit 10 offset 1

select count(*)
from anomaly a
join site s on s.site_id = a.site_id
where s.study_id = 11

select count(distinct(a.subject_id))
from anomaly a
join site s on s.site_id = a.site_id
where s.study_id = 11


select ds.dataset_id, ds.dataset_name,
(
	select count(*)
	from anomaly a
	join data_field df on df.data_field_id = a.data_field_id
	where df.dataset_id = ds.dataset_id
	and a.site_id = 7
    and a.is_an_issue = 1
) site_total,
(
	select count(*)
	from anomaly a
	join data_field df on df.data_field_id = a.data_field_id
	where df.dataset_id = ds.dataset_id
    and a.is_an_issue = 1
	and a.has_been_viewed = 0
	and a.site_id = 7
) site_unviewed
from dataset ds
where ds.study_id = 11
limit 5
offset 10

select ds.dataset_id, ds.dataset_name,
(
	select count(*)
	from anomaly a
	join data_field df on df.data_field_id = a.data_field_id
	where df.dataset_id = ds.dataset_id
	and a.subject_id = 1
    and a.is_an_issue = 1
) total,
(
	select count(*)
	from anomaly a
	join data_field df on df.data_field_id = a.data_field_id
	where df.dataset_id = ds.dataset_id
	and a.subject_id = 1
	and a.is_an_issue = 1
	and a.has_been_viewed = 0
) unviewed
from dataset ds
where ds.study_id = 11
limit 5
offset 10

insert into data_check (data_check_code, data_check_name, description, num_variables)
values ('UU', 'Unsupervised Univariate',
	'Checks individual numeric variables for extreme values', 1);


insert into study(study_name) values('PROSE');

insert into study_folder(folder_path, study_id)
values('S:/RhoFED/ICAC2/PROSE/Statistics/Data/Complete', 2);

insert into global_parameters_version (data_check_id) values(1);

insert into global_parameter(parameter_name, parameter_value, global_parameters_version_id)
values ("lower_boundary_sd", "2", 1);

insert into global_parameter(parameter_name, parameter_value, global_parameters_version_id)
values ("upper_boundary_sd", "2", 1)

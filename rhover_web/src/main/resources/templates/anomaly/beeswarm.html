<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head> 
    <title>RhoVer Beeswarm Chart</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="/rhover.css"/>
    <link rel="stylesheet" href="/jquery-ui.css"/>
    <link rel="icon" type="image/png" href="/images/rover-favicon.png" />
    <script src="/d3.min.js"></script>
    <script src="/jquery-3.2.1.min.js"></script>
    <script src="/jquery-ui.js"></script>
    <script src="/beeswarm.js"></script>
</head>
<body>
	<div id="breadcrumbs">
		<a href="/browse/studies">Studies</a>
		>
		
		<!-- Showing all anomalies from study -->
		<span th:if="${site == null and subject == null}">
			<a th:href="@{/browse/datasets(study_id=${field.study.studyId})}" th:text="${field.study.studyName}"/>
			>
			<a th:href="@{/browse/data_fields(dataset_id=${dataset.datasetId})}" th:text="${dataset.datasetName}"/>
		</span>
		
		<!-- Showing anomalies from one site -->
		<span th:if="${site}">
			<a th:href="@{/browse/sites(study_id=${site.study.studyId})}" th:text="${site.study.studyName}"/>
			>
			<a th:href="@{/browse/datasets(site_id=${site.siteId})}" th:text="'Site ' + ${site.siteName}"/>
			>
			<a th:href="@{/browse/data_fields(dataset_id=${dataset.datasetId}, site_id=${site.siteId})}" th:text="${dataset.datasetName}"/>
		</span>
		
		<!-- Showing anomalies from one subject -->
		<span th:if="${subject}">
			<a th:href="@{/browse/subjects(study_id=${subject.site.study.studyId})}" th:text="${subject.site.study.studyName}"/>
			>
			<a th:href="@{/browse/datasets(subject_id=${subject.subjectId})}" th:text="'Subject ' + ${subject.subjectName}"/>
			>
			<a th:href="@{/browse/data_fields(dataset_id=${dataset.datasetId}, subject_id=${subject.subjectId})}" th:text="${dataset.datasetName}"/>
		</span>
		>
		<strong><span th:text="${field.fieldLabel}"/></strong>

	</div>
	
	<div id="content">
	
		<div style="float: left; width: 300px; border: 1px solid grey; padding: 10px;" id="div_controls">
			<div style="text-align: left">
				<img src="/images/close.png" width="25" height="25" id="close_controls"/>
			</div>
			<div id="accordion">
				<h3>Data Filters</h3>
				<div>
					<table class="invisible">
						<tr>
							<th>Site</th>
							<th>Phase</th>
						</tr>
						<tr>
							<td>
								<select multiple="true">
									<option th:each="site : ${sites}" th:text="${site.siteName}"/>
								</select>
							</td>
							<td>
								<select multiple="true">
									<option th:each="phase : ${phases}" th:text="${phase.phaseName}"/>
								</select>
							</td>
						</tr>
					</table>
				</div>
				
				<h3>Group Data By</h3>
				<div>
					<table class="grid">
						<tr>
							<td><input type="radio" name="group_by" value="none" checked="true"/></td>
							<td align="left">Do not group</td>
						</tr>
					 	<tr>
							<td><input type="radio" name="group_by" value="site"/></td>
							<td align="left">Site</td>
						</tr>
						<tr>
							<td><input type="radio" name="group_by" value="phase"/></td>
							<td align="left">Phase</td>
						</tr>
					</table>
				</div>
				
				<h3>Highlight Data</h3>
				<div>
					<table class="invisible">
						<tr>
							<th>Site</th>
							<th>Phase</th>
						</tr>
						<tr>
							<td>
								<select multiple="true">
									<option th:each="site : ${sites}" th:text="${site.siteName}"/>
								</select>
							</td>
							<td>
								<select multiple="true">
									<option th:each="phase : ${phases}" th:text="${phase.phaseName}"/>
								</select>
							</td>
						</tr>
					</table>
					
					<p>
						Subject
						<input type="text" id="input_subject"/>
					</p>
				</div>
			</div>
		</div>
		
		<div style="float: left; width: 475px">
			<div id="tabs">
				<ul>
					<li><a href="#check_params">Data Check Settings</a></li>
					<li><a href="#view">View</a></li>
					<li><a href="#actions">Actions</a></li>
				</ul>
				<div id="check_params">
					<label for="spinner_sd">Outlier Boundary</label>
					<input id="spinner_sd" size="2" th:value="${num_sd}"/>
					<button type="button">Apply</button>
				</div>
				
				<div id="view">
					<button type="button" id="button_options">Chart Options</button>
					<button type="button" id="button_charts">Other Charts</button>
				</div>
				
				<div id="actions">
					Actions
				</div>
			</div>
			
			<div>
				<svg/>
			</div>
	
			<h3 th:text="${field.fieldLabel}"/>
		</div>
		
		<div id="dialog_data">
    		<table id="dialog_data_table" class="wide"/>
    	</div>
    	
    	<div id="dialog_progress">
    		
    	</div>
			
	</div>
    
</body>

<script th:inline="javascript">
	const url = "/rest/anomaly/data/univariate_outliers?check_run_id=" + [[${check_run_id}]];
	
	// TODO: Consider consolidating this variable with fieldName1 below
	const fieldName = [[${field_name}]];
	
	const mean = parseFloat([[${mean}]]);
	const sd = parseFloat([[${sd}]]);
	const siteName = [[${site_name}]];
	const subjectName = [[${subject_name}]];
	const numSd = parseFloat([[${num_sd}]]);
	const siteFieldName = [[${site_field_name}]];
	const subjectFieldName = [[${subject_field_name}]];
	const studyId = [[${field.study.studyId}]];
	const datasetName = [[${dataset.datasetName}]];
	const datasetId = [[${dataset.datasetId}]];
	const fieldName1 = [[${field.fieldName}]];
	
	$(function() {
		$("#dialog_data").dialog({
			autoOpen: false,
			modal: true,
			minWidth: 800,
			buttons: [
				{
					text: "OK",
					click: function() {
						$(this).dialog("close");
					}
				}
			]
		});
		
		$("#button_options").click(function() {
			$("#div_controls").toggle("slide", 500);
		});
		
		$("#text_second_field").autocomplete({
			minLength: 4,
			source: function(request, response) {
				const url = "/rest/admin/study/get_matching_field_instances?study_id="
					+ studyId + "\u0026term=" + request.term;
				$.get(url)
					.done(function(data) {
						response(data);
					})
					.fail(function() {
						console.log("Error");
					});
			},
			select: function(event, ui) {

				// Extract field and dataset name from search box.
				// Autocomplete will have inserted text in the following format:
				// FIELD_LABEL (FIELD_NAME) [DATASET_NAME]
				const value = ui.item.value;
				const namePatt = new RegExp("\\(.*\\)");
				const fieldNameField = namePatt.exec(value);
				const datasetPatt = new RegExp("\\[.*\\]");
				const datasetField = datasetPatt.exec(value);

				// TODO: Add logic to deal with invalid variables
				const fieldName2 = fieldNameField[0].substring(1, fieldNameField[0].length - 1);
				const datasetName2 = datasetField[0].substring(1, datasetField[0].length - 1);
				
				const url = "/anomaly/bivariate_scatter?" +
						"field_name_1=" + fieldName1 + "\u0026" +
						"dataset_name_1=" + datasetName + "\u0026" +
						"field_name_2=" + fieldName2 + "\u0026" +
						"dataset_name_2=" + datasetName2 + "\u0026" +
						"dataset_id=" + datasetId;
				window.location = url;
			}
		});
		
		$("#tabs").tabs();
		
		$("#accordion").accordion();
		
		$("#close_controls").click(function() {
			$("#div_controls").toggle("slide", 500);
		});
		
		$("#div_controls").toggle("slide", 5);
	});
	
	$("#button_show").click(function() {
		data = getSelectedData();
		varNames = Object.keys(data[0]);
		varNames.splice(varNames.indexOf("anomaly_id"), 1);
		let html = "<tr>";
		for (var i in varNames) {
			html += "<th>";
			html += varNames[i];
			html += "</th>"
		}
		for (var i in data) {
			html += "<tr>"
			for (var j in varNames) {
				html += "<td>";
				html += data[i][varNames[j]];
				html += "</td>"
			}
			html += "</tr>"
		}
		html += "</tr>";
		$("#dialog_data_table").html(html);
		$("#dialog_data").dialog("open");
	});
	
	$("#button_filter").click(function() {
		setFilter($("#select_filter").val(), $("#text_filter").val());
		reDraw();
	});
	
	if (siteName != "-1") {
		setFilter("site", siteName);
	}
	else if (subjectName != "-1") {
		setFilter("subject", subjectName);
	}
	else {
		setFilter("none");
	}
	
	renderBeeswarm(url, fieldName, mean, sd, numSd, siteFieldName, subjectFieldName, function(itemsAreSelected) {
		if (itemsAreSelected) {
			$("#button_show").prop("disabled", false);
			$("#select_issue").prop("disabled", false);
			$("#button_status").prop("disabled", false);
		}
		else {
			$("#button_show").prop("disabled", true);
			$("#select_issue").prop("disabled", true);
			$("#button_status").prop("disabled", true);
		}
	});
</script>

<script>
	$("#spinner_sd").spinner({
		step: 0.25,
		numberFormat: "n",
		stop: function() {
			const sd = $("#spinner_sd").val();
			setThresholdLines(sd);
		}
	});
	
</script>
</html>